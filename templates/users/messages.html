<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .chat-selected {
            background: #eaf6e3;
        }
        .chat-unselected {
            background: #fff;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #F0F0F0;
            color: #333;
            min-height: 100vh;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main {
            height: 85%;
            background-color: #E2F0D9;
            padding: 25px 50px;
            overflow-y: auto;
            display: flex;
        }

        .parent {
            display: grid;
            grid-template-columns: 400px 1fr;
            grid-template-rows: 1fr 260px;
            gap: 10px 10px;
            width: 100%;
            max-width: 98vw;
            margin: 0 auto;
        }


        .div2 {
            grid-column: 2 / 3;
            grid-row: 1 / 3;
            background: #fff;
            border-radius: 15px;
            padding: 25px 20px 10px 20px;
            box-shadow: 0 2px 8px #e1efd8;
            min-width: 0;
        }

        @media (max-width: 1100px) {
            .parent {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            .div1, .div2, .div3 {
                grid-column: 1 / 2 !important;
                grid-row: auto !important;
            }
        }
    </style>
</head>
<body>

    {% include 'partials/navbar.html' %}

    <div class="main">
        <div class="parent">
            {% include 'partials/user_sidebar.html' %}
            <div class="div2">
                <div style="display: flex; height: 100%;">
                    <!-- Chat List Sidebar -->
                    <div style="width: 260px; background: #f6f6f6; border-radius: 10px 0 0 10px; box-shadow: 0 1px 4px #e1efd8; padding: 15px 0; display: flex; flex-direction: column; gap: 0;">
                        <h3 style="text-align: center; color: #6bb13a; font-size: 1.2em; margin-bottom: 10px;">Recent Shops</h3>
                        <div style="flex: 1; overflow-y: auto;">
                            {% for chat_shop_id, shop_name in recent_chats %}
                                {% set btn_class = 'chat-selected' if chat_shop_id == shop_id else 'chat-unselected' %}
                                <form method="get" action="{{ url_for('user_messages') }}" style="margin:0;">
                                    <input type="hidden" name="shop_id" value="{{ chat_shop_id }}">
                                    <button type="submit" class="{{ btn_class }}" style="width: 100%; border: none; border-bottom: 1px solid #e2f0d9; padding: 14px 10px; text-align: left; font-size: 1em; color: #222; cursor: pointer;">{{ shop_name }}</button>
                                </form>
                            {% else %}
                                <div style="padding: 14px 10px; color: #888;">No recent chats.</div>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- Chat Messages Area -->
                    <div style="flex: 1; background: #fff; border-radius: 0 10px 10px 0; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px 25px; position: relative;">
                        <div style="flex: 1; overflow-y: auto; margin-bottom: 15px; display: flex; flex-direction: column; gap: 12px;">
                            {% if shop_id and shop_name %}
                                <div style="font-size: 1.1em; color: #6bb13a; margin-bottom: 10px;">Chatting with <b>{{ shop_name }}</b></div>
                                {% for msg in messages %}
                                    {% if msg.sender_type == 'user' %}
                                        <div style="align-self: flex-end; max-width: 70%;">
                                            <div style="background: #6bb13a; color: #fff; padding: 10px 16px; border-radius: 16px 16px 0 16px; font-size: 1em; box-shadow: 0 1px 2px #e1efd8;">{{ msg.content }}</div>
                                            <div style="font-size: 0.8em; color: #888; text-align: right; margin-top: 2px;">You • {{ msg.timestamp.strftime('%I:%M %p') }}</div>
                                        </div>
                                    {% else %}
                                        <div style="align-self: flex-start; max-width: 70%;">
                                            <div style="background: #eaf6e3; color: #222; padding: 10px 16px; border-radius: 16px 16px 16px 0; font-size: 1em; box-shadow: 0 1px 2px #e1efd8;">{{ msg.content }}</div>
                                            <div style="font-size: 0.8em; color: #888; margin-top: 2px;">{{ shop_name }} • {{ msg.timestamp.strftime('%I:%M %p') }}</div>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div style="color: #888;">No messages yet.</div>
                                {% endfor %}
                            {% else %}
                                <div style="color: #888;">Select a shop to start chatting.</div>
                            {% endif %}
                        </div>
                        <!-- Chat input -->
                        {% if shop_id and shop_name %}
                        <form method="post" style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" name="message" placeholder="Type a message..." style="flex: 1; padding: 10px 14px; border-radius: 20px; border: 1px solid #e2f0d9; font-size: 1em; outline: none;" required />
                            <button type="submit" style="background: #6bb13a; color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; cursor: pointer;">
                                <span>&#9658;</span>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>