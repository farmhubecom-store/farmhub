<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #F0F0F0;
            color: #333;
            min-height: 100vh;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main {
            height: 85%;
            background-color: #E2F0D9;
            padding: 25px 50px;
            overflow-y: auto;
            display: flex;
        }

        .parent {
            display: grid;
            grid-template-columns: 400px 1fr;
            grid-template-rows: 1fr 260px;
            gap: 10px 10px;
            width: 100%;
            max-width: 98vw;
            margin: 0 auto;
            height: 100%;
        }

        .div1 {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            background: #fff;
            border-radius: 20px;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 8px #e1efd8;
            min-width: 0;
            min-height: 0;
        }
        .div2 {
            grid-column: 2 / 3;
            grid-row: 1 / 3;
            background: #fff;
            border-radius: 15px;
            padding: 25px 20px 10px 20px;
            box-shadow: 0 2px 8px #e1efd8;
            min-width: 0;
            min-height: 0; /* allow the grid item to shrink so overflow works */
            overflow-y: auto; /* make inner content scrollable */
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 1100px) {
            .parent {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            .div1, .div2, .div3 {
                grid-column: 1 / 2 !important;
                grid-row: auto !important;
            }
        }
        /* Order status styles */
        .order-item { background: #fff; transition: background-color .2s ease; }
        .status-pending { background: #fff8e1; border-left: 6px solid #ffc107; }
        .status-confirmed { background: #e9f5ff; border-left: 6px solid #0d6efd; }
        .status-delivered { background: #e9fdef; border-left: 6px solid #28a745; }
        .status-cancelled { background: #fdecea; border-left: 6px solid #dc3545; }
        .status-processing { background: #fff6e6; border-left: 6px solid #fd7e14; }
    </style>
</head>
<body>

    {% include 'partials/navbar.html' %}

    <div class="main">
        <div class="parent">

            {% include 'partials/shop_sidebar.html' %}

            <div class="div2">
                <h2 style="margin-bottom: 20px;">Order History</h2>
                <div class="order-history-list">
                    {% if orders and orders|length > 0 %}
                        {% for order in orders %}
                            <div class="order-item status-{{ order['status'] }}" style="display:flex;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;box-shadow:0 1px 3px #eaeaea;">
                                {% set first = order['items'][0] if order['items'] else None %}
                                {% if first and first['image'] %}
                                    {% if first['image'].startswith('http') or first['image'].startswith('https') %}
                                        <img src="{{ first['image'] }}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:12px;border:1px solid #e2f0d9;">
                                    {% elif first['image'].startswith('/') %}
                                        <img src="{{ first['image'] }}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:12px;border:1px solid #e2f0d9;">
                                    {% else %}
                                        <img src="{{ url_for('static', filename='images/product-images/' ~ first['image']) }}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:12px;border:1px solid #e2f0d9;">
                                    {% endif %}
                                {% else %}
                                    <img src="{{ url_for('static', filename='images/product-images/banana-lakatan.jpg') }}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:12px;border:1px solid #e2f0d9;">
                                {% endif %}
                                <div style="flex:1;">
                                    <div style="font-weight:700">Order #{{ order['id'] }} - {{ order['buyer_name'] or 'Buyer' }}</div>
                                    <div style="color:#666;font-size:0.9em">Ordered on: {{ order['timestamp'] }}</div>
                                    <div style="color:#444;font-weight:600;margin-top:6px;">Status: {{ order['status'] }}</div>
                                    {% if order['delivery_date'] %}
                                        <div style="color:#666;font-size:0.9em">Delivery date: {{ order['delivery_date'] }}</div>
                                    {% endif %}

                                    {# buyer contact: try several common field names and show links when present #}
                                    {% set buyer_phone = order['buyer_phone'] if order.get('buyer_phone') else (order['buyer_contact'] if order.get('buyer_contact') else (order['buyer_phone_number'] if order.get('buyer_phone_number') else None)) %}
                                    {% set buyer_email = order['buyer_email'] if order.get('buyer_email') else (order['buyer_contact_email'] if order.get('buyer_contact_email') else None) %}

                                    {% if buyer_phone or buyer_email %}
                                        <div style="margin-top:8px;color:#333;font-size:0.95em;">
                                            <strong>Contact</strong>
                                            <div style="color:#666;font-size:0.9em;margin-top:4px;">
                                                {% if buyer_phone %}
                                                    <div>Phone: <a href="tel:{{ buyer_phone }}" style="color:#007bff;text-decoration:none;">{{ buyer_phone }}</a></div>
                                                {% endif %}
                                                {% if buyer_email %}
                                                    <div>Email: <a href="mailto:{{ buyer_email }}" style="color:#007bff;text-decoration:none;">{{ buyer_email }}</a></div>
                                                {% endif %}
                                                {% if order.get('buyer_address') %}
                                                    <div style="margin-top:6px; color:#666;">Address: {{ order['buyer_address'] }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <div style="margin-top:8px;color:#666;font-size:0.9em;">Contact: N/A</div>
                                    {% endif %}
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:1em;color:#333">₱{{ '%.2f'|format(order['total']) }}</div>
                                    <div style="color:#888">Items: {{ order['items']|length }}</div>
                                    {% if order['status'] == 'pending' %}
                                        <form action="{{ url_for('seller_confirm_order', order_id=order['id']) }}" method="post" style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end;">
                                            <input type="date" name="delivery_date" required style="padding:6px;border-radius:6px;border:1px solid #ccc;">
                                            <button type="submit" style="background:#007bff;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;">Confirm</button>
                                        </form>
                                        <form action="{{ url_for('seller_cancel_order', order_id=order['id']) }}" method="post" style="margin-top:6px;">
                                            <button type="submit" style="background:#dc3545;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;margin-top:6px;">Cancel</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                            {% for item in order['items'] %}
                                <div style="display:flex;align-items:center;padding:8px 10px;border-radius:8px;margin-bottom:6px;background:#f9f9f9;">
                                    {% if item['image'] %}
                                        {% if item['image'].startswith('http') or item['image'].startswith('https') %}
                                            <img src="{{ item['image'] }}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;margin-right:10px;border:1px solid #e2f0d9;">
                                        {% elif item['image'].startswith('/') %}
                                            <img src="{{ item['image'] }}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;margin-right:10px;border:1px solid #e2f0d9;">
                                        {% else %}
                                            <img src="{{ url_for('static', filename='images/product-images/' ~ item['image']) }}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;margin-right:10px;border:1px solid #e2f0d9;">
                                        {% endif %}
                                    {% else %}
                                        <img src="{{ url_for('static', filename='images/product-images/banana-lakatan.jpg') }}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;margin-right:10px;border:1px solid #e2f0d9;">
                                    {% endif %}
                                    <div style="flex:1;">
                                        <div style="font-weight:600">{{ item['name'] }}</div>
                                        <div style="color:#666">Qty: {{ item['quantity'] }}</div>
                                    </div>
                                    <div style="text-align:right;color:#333">₱{{ '%.2f'|format(item['subtotal']) }}</div>
                                </div>
                            {% endfor %}
                            <hr style="border:none;border-top:1px solid #eee;margin:8px 0;">
                        {% endfor %}
                    {% else %}
                        <p>No orders yet.</p>
                    {% endif %}
                </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>